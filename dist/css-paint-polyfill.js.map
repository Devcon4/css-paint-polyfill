{"version":3,"file":"css-paint-polyfill.js","sources":["../src/util.js","../src/index.js","../src/realm.js"],"sourcesContent":["/**\n * Copyright 2018 Google Inc. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *     http://www.apache.org/licenses/LICENSE-2.0\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** Canvas#toBlob() ponyfill */\nexport function canvasToBlob(canvas, callback, type, quality) {\n\tif (canvas.toBlob) return canvas.toBlob(callback, type, quality);\n\n\tlet bin = atob(canvas.toDataURL(type, quality).split(',')[1]),\n\t\tarr = new Uint8Array(bin.length);\n\tfor (let i=0; i<bin.length; i++) arr[i] = bin.charCodeAt(i);\n\tcallback(new Blob([arr], { type }));\n}\n\n/** Basically fetch(u).then( r => r.text() ) */\nexport function fetchText(url, callback) {\n\tlet xhr = new XMLHttpRequest();\n\txhr.onreadystatechange = () => {\n\t\tif (xhr.readyState===4) {\n\t\t\tcallback(xhr.responseText);\n\t\t}\n\t};\n\txhr.open('GET', url, true);\n\txhr.send();\n}\n\n/** Object.defineProperty() ponyfill */\nexport function defineProperty(obj, name, def) {\n\tif (Object.defineProperty) {\n\t\tObject.defineProperty(obj, name, def);\n\t}\n\telse {\n\t\tobj[name] = def.get();\n\t}\n}\n","/**\n * Copyright 2018 Google Inc. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *     http://www.apache.org/licenses/LICENSE-2.0\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Realm } from './realm';\nimport { defineProperty, fetchText } from './util';\n\nlet paintWorklet;\n\n// Use a getter here (if available) to avoid installing\n// our MutationObserver if the API is never used.\nif (!window.CSS) window.CSS = {};\n\nif (!('paintWorklet' in window.CSS)) {\n\tdefineProperty(window.CSS, 'paintWorklet', {\n\t\tget: () => (paintWorklet || (paintWorklet = new PaintWorklet()))\n\t});\n}\n\nconst GLOBAL_ID = 'css-paint-polyfill';\n\nlet root = document.createElement(GLOBAL_ID);\nroot.style.cssText = 'display: none;';\ndocument.documentElement.appendChild(root);\n\nlet overridesStylesheet = document.createElement('style');\noverridesStylesheet.id = GLOBAL_ID;\noverridesStylesheet.$$isPaint = true;\nroot.appendChild(overridesStylesheet);\nlet overrideStyles = overridesStylesheet.sheet;\nlet testStyles = root.style;\n\nconst EMPTY_ARRAY = [];\nconst HAS_PAINT = /(paint\\(|-moz-element\\(#paint-|-webkit-canvas\\(paint-|[('\"]blob:[^'\"#]+#paint=|[('\"]data:image\\/paint-)/;\nconst USE_CSS_CANVAS_CONTEXT = 'getCSSCanvasContext' in document;\nconst USE_CSS_ELEMENT = (testStyles.backgroundImage = `-moz-element(#${GLOBAL_ID})`) === testStyles.backgroundImage;\nconst HAS_PROMISE = (typeof Promise === 'function');\ntestStyles.cssText = '';\n\nlet supportsStyleMutations = true;\nlet raf = window.requestAnimationFrame || setTimeout;\nlet defer = HAS_PROMISE ? Promise.prototype.then.bind(Promise.resolve()) : setTimeout;\nlet getDevicePixelRatio = () => window.devicePixelRatio || 1;\n\nlet painters = {};\nlet trackedRules = {};\nlet styleSheetCounter = 0;\n\nfunction registerPaint(name, Painter, worklet) {\n\t// if (painters[name]!=null) throw Error(`registerPaint(${name}): name already registered`);\n\tpainters[name] = {\n\t\tworklet,\n\t\tPainter,\n\t\tproperties: Painter.inputProperties ? [].slice.call(Painter.inputProperties) : [],\n\t\tbit: 0,\n\t\tinstances: []\n\t};\n\tupdate();\n}\n\nfunction getPainter(name) {\n\tlet painter = painters[name];\n\t// if (painter == null) throw Error(`No paint defined for \"${name}\"`);\n\treturn painter;\n}\n\nfunction getPainterInstance(painter) {\n\t// Alternate between two instances.\n\t// @TODO should alternate between two *worklets*. Class instances are meaningless for perf.\n\tlet inst = painter.bit ^= 1;\n\treturn painter.instances[inst] || (painter.instances[inst] = new painter.Painter());\n}\n\nfunction paintRuleWalker(rule, context) {\n\tlet css = rule.cssText;\n\n\tif (context.isNew === true && HAS_PAINT.test(css)) {\n\t\tif (css !== (css = escapePaintRules(css))) {\n\t\t\trule = replaceRule(rule, css);\n\t\t}\n\t}\n\n\tlet selector = rule.selectorText,\n\t\tcssText = getCssText(rule.style),\n\t\tindex, key, cached;\n\n\tif (context.counters[selector] == null) {\n\t\tindex = context.counters[selector] = 1;\n\t}\n\telse {\n\t\tindex = ++context.counters[selector];\n\t}\n\tkey = 'sheet' + context.sheetId + '\\n' + selector + '\\n' + index;\n\tif (trackedRules[key] != null) {\n\t\tcached = trackedRules[key];\n\t\tif (cached.selector === selector) {\n\t\t\tcached.rule = rule;\n\t\t\tif (cached.cssText !== cssText) {\n\t\t\t\tcontext.toProcess.push(cached);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\t\tcontext.toRemove.push(cached);\n\t}\n\telse {\n\t\tcached = trackedRules[key] = { key, selector, cssText, properties: {}, rule };\n\t\tcontext.toProcess.push(cached.selector);\n\t}\n}\n\nfunction walk(node, iterator) {\n\titerator(node);\n\tlet child = node.firstElementChild;\n\twhile (child) {\n\t\twalk(child, iterator);\n\t\tchild = child.nextElementSibling;\n\t}\n}\n\nfunction update() {\n\tlet sheets = [].slice.call(document.styleSheets),\n\t\tcontext = {\n\t\t\ttoProcess: [],\n\t\t\ttoRemove: [],\n\t\t\tcounters: {},\n\t\t\tisNew: false,\n\t\t\tsheetId: null\n\t\t};\n\n\tfor (let i=0; i<sheets.length; i++) {\n\t\tlet node = sheets[i].ownerNode;\n\t\tif (node.$$isPaint) continue;\n\t\tcontext.sheetId = node.$$paintid;\n\t\tcontext.isNew = context.sheetId == null;\n\t\tif (context.isNew) {\n\t\t\tcontext.sheetId = node.$$paintid = ++styleSheetCounter;\n\t\t\t// allow processing to defer parse\n\t\t\tif (processNewSheet(node)===false) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t}\n\t\twalkStyles(node.sheet, paintRuleWalker, context);\n\t}\n\n\tfor (let i = context.toRemove.length; i--; ) {\n\t\t// @todo cleanup?\n\t\tdelete trackedRules[context.toRemove[i].key];\n\t}\n\n\tif (context.toProcess.length>0) {\n\t\tprocessItem(context.toProcess.join(', '));\n\t}\n}\n\nfunction walkStyles(sheet, iterator, context) {\n\tlet stack = [[0, sheet.cssRules]],\n\t\tcurrent = stack[0],\n\t\trules = current[1];\n\tif (rules) {\n\t\tfor (let j=0; stack.length>0; j++) {\n\t\t\tif (j>=rules.length) {\n\t\t\t\tstack.pop();\n\t\t\t\tlet len = stack.length;\n\t\t\t\tif (len > 0) {\n\t\t\t\t\tcurrent = stack[len - 1];\n\t\t\t\t\trules = current[1];\n\t\t\t\t\tj = current[0];\n\t\t\t\t}\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tcurrent[0] = j;\n\t\t\tlet rule = rules[j];\n\t\t\tif (rule.type !== 1) {\n\t\t\t\tif (rule.cssRules && rule.cssRules.length>0) {\n\t\t\t\t\tstack.push([0, rule.cssRules]);\n\t\t\t\t}\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tlet r = iterator(rule, context);\n\t\t\tif (r!==undefined) context = r;\n\t\t}\n\t}\n\treturn context;\n}\n\nfunction replaceRule(rule, newRule) {\n\tlet sheet = rule.parentStyleSheet,\n\t\tparent = rule.parentRule,\n\t\trules = (parent || sheet).cssRules,\n\t\tindex = rules.length - 1;\n\tfor (let i=0; i<=index; i++) {\n\t\tif (rules[i] === rule) {\n\t\t\t(parent || sheet).deleteRule(i);\n\t\t\tindex = i;\n\t\t\tbreak;\n\t\t}\n\t}\n\tif (newRule!=null) {\n\t\tif (parent) {\n\t\t\tlet index = parent.appendRule(newRule);\n\t\t\treturn parent.cssRules[index];\n\t\t}\n\t\tsheet.insertRule(newRule, index);\n\t\treturn sheet.cssRules[index];\n\t}\n}\n\n// Replace paint(id) with url(data:image/paint-id) for a newly detected stylesheet\nfunction processNewSheet(node) {\n\tif (node.$$isPaint) return;\n\n\tif (node.href) {\n\t\tfetchText(node.href, processRemoteSheet);\n\t\treturn false;\n\t}\n\n\tfor (let i=node.childNodes.length; i--; ) {\n\t\tlet css = node.childNodes[i].nodeValue;\n\t\tlet escaped = escapePaintRules(css);\n\t\tif (escaped !== css) {\n\t\t\tnode.childNodes[i].nodeValue = escaped;\n\t\t}\n\t}\n}\n\nfunction processRemoteSheet(css) {\n\tlet style = document.createElement('style');\n\tstyle.disabled = true;\n\tstyle.$$paintid = ++styleSheetCounter;\n\tstyle.appendChild(document.createTextNode(escapePaintRules(css)));\n\t(document.head || document.createElement('head')).appendChild(style);\n\tlet sheet = style.sheet,\n\t\ttoDelete = [],\n\t\trule;\n\twalkStyles(sheet, accumulateNonPaintRules, toDelete);\n\twhile ( (rule = toDelete.pop()) ) replaceRule(rule, null);\n\tupdate();\n\tstyle.disabled = false;\n}\n\nfunction accumulateNonPaintRules(rule, nonPaintRules) {\n\tif (!HAS_PAINT.test(rule.cssText)) {\n\t\tnonPaintRules.push(rule);\n\t}\n}\n\nfunction escapePaintRules(css) {\n\treturn css.replace(/(;|,|\\b)paint\\s*\\(\\s*(['\"]?)(.+?)\\2\\s*\\)(;|,|!|\\b)/g, '$1url(data:image/paint-$3,=)$4');\n}\n\nlet updateQueue = [];\nfunction queueUpdate(element) {\n\tif (element.$$paintPending===true) return;\n\telement.$$paintPending = true;\n\tif (updateQueue.indexOf(element) === -1 && updateQueue.push(element) === 1) {\n\t\tdefer(processUpdateQueue);\n\t}\n}\nfunction processUpdateQueue() {\n\tlet el;\n\twhile ((el = updateQueue.pop())) {\n\t\tmaybeUpdateElement(el);\n\t}\n}\n\nfunction processItem(selector) {\n\tlet sel = document.querySelectorAll(selector);\n\tfor (let i=0; i<sel.length; i++) queueUpdate(sel[i]);\n}\n\nfunction loadImages(images, callback, args) {\n\tlet count = images.length;\n\tlet onload = () => {\n\t\tif (--count) return;\n\t\tcallback.apply(null, args || EMPTY_ARRAY);\n\t};\n\tfor (let i=0; i<images.length; i++) {\n\t\tlet img = new Image();\n\t\timg.onload = onload;\n\t\timg.onerror = onerror;\n\t\timg.src = images[i];\n\t}\n}\n\nfunction ensurePaintId(element) {\n\tlet paintId = element.$$paintId;\n\tif (paintId==null) {\n\t\tpaintId = element.$$paintId = ++idCounter;\n\t\tpatchCssText(element);\n\t}\n\treturn paintId;\n}\n\nfunction getPaintRuleForElement(element) {\n\tlet paintRule = element.$$paintRule,\n\t\tpaintId = ensurePaintId(element);\n\tif (paintRule==null) {\n\t\tif (!element.hasAttribute('data-css-paint')) {\n\t\t\telement.setAttribute('data-css-paint', paintId);\n\t\t}\n\t\tlet index = overrideStyles.insertRule(`[data-css-paint=\"${idCounter}\"] {}`, overrideStyles.cssRules.length);\n\t\tpaintRule = element.$$paintRule = overrideStyles.cssRules[index];\n\t}\n\treturn paintRule;\n}\n\nfunction getCssText(style) {\n\tlet text = style.cssText;\n\tif (text) return text;\n\ttext = '';\n\tfor (let i=0, prop; i<style.length; i++) {\n\t\tprop = style[i];\n\t\tif (i!==0) text += ' ';\n\t\ttext += prop;\n\t\ttext += ':';\n\t\ttext += style.getPropertyValue(prop);\n\t\ttext += ';';\n\t}\n\treturn text;\n}\n\nfunction maybeUpdateElement(element) {\n\tlet computed = getComputedStyle(element);\n\tif (element.$$paintObservedProperties) {\n\t\tfor (let i=0; i<element.$$paintObservedProperties.length; i++) {\n\t\t\tlet prop = element.$$paintObservedProperties[i];\n\t\t\tif (computed.getPropertyValue(prop).trim() !== element.$$paintedPropertyValues[prop].trim()) {\n\t\t\t\tupdateElement(element, computed);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\telse if (element.$$paintId || HAS_PAINT.test(getCssText(computed))) {\n\t\tupdateElement(element, computed);\n\t\treturn;\n\t}\n\n\telement.$$paintPending = false;\n}\n\nlet currentProperties, propertyContainerCache;\nconst propertiesContainer = {\n\tget(name) {\n\t\tif (name in propertyContainerCache) return propertyContainerCache[name];\n\t\treturn propertyContainerCache[name] = currentProperties.getPropertyValue(name);\n\t}\n};\n\nlet idCounter = 0;\nfunction updateElement(element, computedStyle) {\n\toverridesStylesheet.disabled = true;\n\tlet style = currentProperties = computedStyle==null ? getComputedStyle(element) : computedStyle;\n\t// element.$$paintGeom = style;\n\tpropertyContainerCache = {};\n\tlet paintRule;\n\tlet observedProperties = [];\n\n\telement.$$paintPending = false;\n\n\t// @TODO get computed styles and precompute geometry in a rAF after first paint, then re-use w/ invalidation\n\tlet geom = {\n\t\twidth: element.clientWidth,\n\t\theight: element.clientHeight\n\t};\n\n\tlet dpr = getDevicePixelRatio();\n\n\tlet paintedProperties = element.$$paintedProperties;\n\n\tfor (let i=0; i<style.length; i++) {\n\t\tlet property = style[i],\n\t\t\tvalue = propertiesContainer.get(property),\n\t\t\treg = /(,|\\b|^)url\\((['\"]?)((?:-moz-element\\(#|-webkit-canvas\\()paint-\\d+-([^;,]+)\\)|(?:data:image\\/paint-|blob:[^'\"#]+#paint=)([^\"';, ]+)[;,].*?)\\2\\)(,|\\b|$)/g,\n\t\t\tnewValue = '',\n\t\t\tindex = 0,\n\t\t\turls = [],\n\t\t\thasChanged = false,\n\t\t\thasPaints = false,\n\t\t\tpaintId,\n\t\t\ttoken;\n\t\twhile ((token = reg.exec(value))) {\n\t\t\tif (hasPaints === false) {\n\t\t\t\tpaintId = ensurePaintId(element);\n\t\t\t}\n\n\t\t\thasPaints = true;\n\t\t\tnewValue += value.substring(0, token.index);\n\t\t\tlet painterName = token[4] || token[5];\n\t\t\tlet currentUri = token[3];\n\t\t\tlet painter = getPainter(painterName);\n\t\t\tlet contextOptions = painter && painter.Painter.contextOptions || {};\n\t\t\tlet equivalentDpr = contextOptions.scaling === false ? 1 : dpr;\n\n\t\t\tlet inst;\n\t\t\tif (painter) {\n\t\t\t\t// if (!painter) {\n\t\t\t\t// \telement.$$paintPending = true;\n\t\t\t\t// \toverridesStylesheet.disabled = false;\n\t\t\t\t// \t// setTimeout(maybeUpdateElement, 10, element);\n\t\t\t\t// \treturn;\n\t\t\t\t// }\n\t\t\t\tif (painter.Painter.inputProperties) {\n\t\t\t\t\tobservedProperties.push.apply(observedProperties, painter.Painter.inputProperties);\n\t\t\t\t}\n\t\t\t\tinst = getPainterInstance(painter);\n\t\t\t}\n\n\t\t\tif (contextOptions.nativePixels===true) {\n\t\t\t\tgeom.width *= dpr;\n\t\t\t\tgeom.height *= dpr;\n\t\t\t\tequivalentDpr = 1;\n\t\t\t}\n\n\t\t\tlet actualWidth = equivalentDpr * geom.width,\n\t\t\t\tactualHeight = equivalentDpr * geom.height;\n\t\t\t\n\t\t\tlet ctx = element.$$paintContext,\n\t\t\t\tcssContextId = `paint-${paintId}-${painterName}`;\n\t\t\tif (!ctx || !ctx.canvas || ctx.canvas.width!=actualWidth || ctx.canvas.height!=actualHeight) {\n\t\t\t\tif (USE_CSS_CANVAS_CONTEXT===true) {\n\t\t\t\t\tctx = document.getCSSCanvasContext('2d', cssContextId, actualWidth, actualHeight);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tlet canvas = document.createElement('canvas');\n\t\t\t\t\tcanvas.id = cssContextId;\n\t\t\t\t\tcanvas.width = actualWidth;\n\t\t\t\t\tcanvas.height = actualHeight;\n\t\t\t\t\tif (USE_CSS_ELEMENT===true) {\n\t\t\t\t\t\tcanvas.style.display = 'none';\n\t\t\t\t\t\troot.appendChild(canvas);\n\t\t\t\t\t}\n\t\t\t\t\tctx = canvas.getContext('2d');\n\t\t\t\t}\n\t\t\t\telement.$$paintContext = ctx;\n\t\t\t\tctx.imageSmoothingEnabled = false;\n\t\t\t\tif (equivalentDpr!==1) ctx.scale(equivalentDpr, equivalentDpr);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tctx.clearRect(0, 0, actualWidth, actualHeight);\n\n\t\t\t\t// This hack is no longer needed thanks to the closePath() fix\n\t\t\t\t// if (USE_CSS_CANVAS_CONTEXT===false) {\n\t\t\t\t// \tctx = ctx.canvas.getContext('2d');\n\t\t\t\t// }\n\t\t\t}\n\n\t\t\tif (inst) {\n\t\t\t\tctx.save();\n\t\t\t\tctx.beginPath();\n\t\t\t\tinst.paint(ctx, geom, propertiesContainer);\n\t\t\t\t// Close any open path so clearRect() can dump everything\n\t\t\t\tctx.closePath();\n\t\t\t\t// ctx.stroke();  // useful to verify that the polyfill painted rather than native paint().\n\t\t\t\tctx.restore();\n\t\t\t\t// -webkit-canvas() is scaled based on DPI by default, we don't want to reset that.\n\t\t\t\tif (USE_CSS_CANVAS_CONTEXT===false && 'resetTransform' in ctx) {\n\t\t\t\t\tctx.resetTransform();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tnewValue += token[1];\n\n\t\t\tif (USE_CSS_CANVAS_CONTEXT===true) {\n\t\t\t\tnewValue += `-webkit-canvas(${cssContextId})`;\n\t\t\t\thasChanged = token[4]==null;\n\t\t\t}\n\t\t\telse if (USE_CSS_ELEMENT===true) {\n\t\t\t\tnewValue += `-moz-element(#${cssContextId})`;\n\t\t\t\thasChanged = token[4] == null;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tlet uri = ctx.canvas.toDataURL('image/png').replace('/png', '/paint-' + painterName);\n\t\t\t\tif (typeof MSBlobBuilder==='function') {\n\t\t\t\t\turi = dataUrlToBlob(uri, painterName);\n\t\t\t\t}\n\t\t\t\t// let uri = ctx.canvas.toDataURL('image/bmp', 1).replace('/bmp', '/paint-' + painterName);\n\t\t\t\turls.push(uri);\n\t\t\t\tnewValue += 'url(\"' + uri + '\")';\n\t\t\t\tif (uri!==currentUri || !paintRule) {\n\t\t\t\t\tlet j = currentUri ? currentUri.indexOf('#') : -1;\n\t\t\t\t\tif (~j) URL.revokeObjectURL(currentUri.substring(0, j));\n\t\t\t\t\thasChanged = true;\n\t\t\t\t}\n\t\t\t\tcurrentUri = uri;\n\t\t\t}\n\n\t\t\tnewValue += token[6];\n\t\t\tindex = token.index + token[0].length;\n\t\t}\n\n\t\tif (hasPaints===false && paintedProperties!=null && paintedProperties[property]!=null) {\n\t\t\tif (!paintRule) paintRule = getPaintRuleForElement(element);\n\t\t\tpaintRule.style.removeProperty(property);\n\t\t\tcontinue;\n\t\t}\n\n\t\tnewValue += value.substring(index);\n\t\tif (hasChanged) {\n\t\t\tif (!paintRule) paintRule = getPaintRuleForElement(element);\n\n\t\t\tif (paintedProperties==null) {\n\t\t\t\tpaintedProperties = element.$$paintedProperties = {};\n\t\t\t}\n\t\t\tpaintedProperties[property] = true;\n\n\t\t\tif (property.substring(0, 10) === 'background' && dpr !== 1) {\n\t\t\t\tapplyStyleRule(paintRule.style, 'background-size', `${geom.width}px ${geom.height}px`);\n\t\t\t}\n\n\t\t\tif (urls.length===0) {\n\t\t\t\tapplyStyleRule(paintRule.style, property, newValue);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tloadImages(urls, applyStyleRule, [paintRule.style, property, newValue]);\n\t\t\t}\n\t\t}\n\t}\n\n\telement.$$paintObservedProperties = observedProperties.length===0 ? null : observedProperties;\n\tlet propertyValues = element.$$paintedPropertyValues = {};\n\tfor (let i=0; i<observedProperties.length; i++) {\n\t\tlet prop = observedProperties[i];\n\t\t// use propertyContainer here to select cached values\n\t\tpropertyValues[prop] = propertiesContainer.get(prop);\n\t}\n\n\toverridesStylesheet.disabled = false;\n}\n\nfunction dataUrlToBlob(dataUrl, name) {\n\tlet bin = atob(dataUrl.split(',')[1]),\n\t\tarr = new Uint8Array(bin.length);\n\tfor (let i=0; i<bin.length; i++) arr[i] = bin.charCodeAt(i);\n\treturn URL.createObjectURL(new Blob([arr])) + '#paint=' + name;\n}\n\nfunction applyStyleRule(style, property, value) {\n\tstyle.setProperty(property, value, 'important');\n}\n\nfunction patchCssText(element) {\n\tif (supportsStyleMutations===true) return;\n\tif (element.style.ownerElement===element) return;\n\tdefineProperty(element.style, 'ownerElement', { value: element });\n}\n\nclass PaintWorklet {\n\tconstructor() {\n\t\traf(update);\n\n\t\tlet a = document.createElement('x-a');\n\t\tdocument.body.appendChild(a);\n\n\t\tlet supportsStyleMutations = false;\n\n\t\tlet lock = false;\n\t\tnew MutationObserver(records => {\n\t\t\tif (lock===true) return;\n\t\t\tlock = true;\n\t\t\tfor (let i = 0; i < records.length; i++) {\n\t\t\t\tlet record = records[i], added;\n\t\t\t\tif (record.type === 'childList' && (added = record.addedNodes)) {\n\t\t\t\t\tfor (let j = 0; j < added.length; j++) {\n\t\t\t\t\t\tif (added[j].nodeType === 1) {\n\t\t\t\t\t\t\tqueueUpdate(added[j]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse if (record.type==='attributes' && record.target.nodeType === 1) {\n\t\t\t\t\tif (record.target === a) {\n\t\t\t\t\t\tsupportsStyleMutations = true;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\twalk(record.target, queueUpdate);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tlock = false;\n\t\t}).observe(document.body, {\n\t\t\tchildList: true,\n\t\t\tattributes: true,\n\t\t\tsubtree: true\n\t\t});\n\n\t\ta.style.cssText = 'color: red;';\n\t\tsetTimeout( () => {\n\t\t\tdocument.body.removeChild(a);\n\t\t\tif (!supportsStyleMutations) {\n\t\t\t\tlet styleDesc = Object.getOwnPropertyDescriptor(HTMLElement.prototype, 'style');\n\t\t\t\tconst oldStyleGetter = styleDesc.get;\n\t\t\t\tstyleDesc.get = function() {\n\t\t\t\t\tconst style = oldStyleGetter.call(this);\n\t\t\t\t\tstyle.ownerElement = this;\n\t\t\t\t\treturn style;\n\t\t\t\t};\n\t\t\t\tdefineProperty(HTMLElement.prototype, 'style', styleDesc);\n\n\t\t\t\tlet cssTextDesc = Object.getOwnPropertyDescriptor(CSSStyleDeclaration.prototype, 'cssText');\n\t\t\t\tlet oldSet = cssTextDesc.set;\n\t\t\t\tcssTextDesc.set = function (value) {\n\t\t\t\t\tif (this.ownerElement) queueUpdate(this.ownerElement);\n\t\t\t\t\treturn oldSet.call(this, value);\n\t\t\t\t};\n\t\t\t\tdefineProperty(CSSStyleDeclaration.prototype, 'cssText', cssTextDesc);\n\n\t\t\t\tlet setPropertyDesc = Object.getOwnPropertyDescriptor(CSSStyleDeclaration.prototype, 'setProperty');\n\t\t\t\tlet oldSetProperty = setPropertyDesc.value;\n\t\t\t\tsetPropertyDesc.value = function (name, value, priority) {\n\t\t\t\t\tif (this.ownerElement) queueUpdate(this.ownerElement);\n\t\t\t\t\toldSetProperty.call(this, name, value, priority);\n\t\t\t\t};\n\t\t\t\tdefineProperty(CSSStyleDeclaration.prototype, 'setProperty', setPropertyDesc);\n\t\t\t}\n\t\t});\n\t}\n\n\taddModule(url) {\n\t\tlet p, resolve;\n\t\tif (HAS_PROMISE) {\n\t\t\tp = new Promise((r) => resolve = r);\n\t\t}\n\n\t\tfetchText(url, code => {\n\t\t\tlet context = {\n\t\t\t\tregisterPaint(name, Painter) {\n\t\t\t\t\tregisterPaint(name, Painter, {\n\t\t\t\t\t\tcontext,\n\t\t\t\t\t\trealm\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t};\n\t\t\tdefineProperty(context, 'devicePixelRatio', {\n\t\t\t\tget: getDevicePixelRatio\n\t\t\t});\n\t\t\tcontext.self = context;\n\t\t\tlet realm = new Realm(context, root);\n\n\t\t\tcode = (this.transpile || String)(code);\n\n\t\t\trealm.exec(code);\n\t\t\tif (resolve) resolve();\n\t\t});\n\n\t\treturn p;\n\t}\n}\n","/**\n * Copyright 2018 Google Inc. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *     http://www.apache.org/licenses/LICENSE-2.0\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nexport function Realm(scope, parentElement) {\n\tlet frame = document.createElement('iframe');\n\tframe.style.cssText = 'position:absolute; left:0; top:-999px; width:1px; height:1px;';\n\tparentElement.appendChild(frame);\n\tlet win = frame.contentWindow,\n\t\tdoc = win.document,\n\t\tvars = 'var window,$hook';\n\tfor (let i in win) {\n\t\tif (!(i in scope) && i!=='eval') {\n\t\t\tvars += ',';\n\t\t\tvars += i;\n\t\t}\n\t}\n\tfor (let i in scope) {\n\t\tvars += ',';\n\t\tvars += i;\n\t\tvars += '=self.';\n\t\tvars += i;\n\t}\n\tlet script = doc.createElement('script');\n\tscript.appendChild(doc.createTextNode(\n\t\t`function $hook(self,console) {\"use strict\";\n\t\t${vars};return function() {return eval(arguments[0])}}`\n\t));\n\tdoc.body.appendChild(script);\n\tthis.exec = win.$hook(scope, console);\n\t// this.destroy = () => { parentElement.removeChild(frame); };\n}\n"],"names":["fetchText","url","callback","let","xhr","XMLHttpRequest","onreadystatechange","readyState","responseText","open","send","defineProperty","obj","name","def","Object","get","paintWorklet","window","CSS","PaintWorklet","const","GLOBAL_ID","root","document","createElement","style","cssText","documentElement","appendChild","overridesStylesheet","id","$$isPaint","overrideStyles","sheet","testStyles","EMPTY_ARRAY","HAS_PAINT","USE_CSS_CANVAS_CONTEXT","USE_CSS_ELEMENT","backgroundImage","HAS_PROMISE","Promise","raf","requestAnimationFrame","setTimeout","defer","prototype","then","bind","resolve","getDevicePixelRatio","devicePixelRatio","painters","trackedRules","styleSheetCounter","getPainterInstance","painter","inst","bit","instances","Painter","paintRuleWalker","rule","context","css","isNew","test","escapePaintRules","replaceRule","index","key","cached","selector","selectorText","getCssText","counters","sheetId","toProcess","push","toRemove","properties","walk","node","iterator","child","firstElementChild","nextElementSibling","update","sheets","slice","call","styleSheets","i","length","ownerNode","$$paintid","processNewSheet","walkStyles","sel","querySelectorAll","queueUpdate","processItem","join","stack","cssRules","current","rules","j","pop","len","type","r","undefined","newRule","parentStyleSheet","parent","parentRule","deleteRule","appendRule","insertRule","href","processRemoteSheet","childNodes","nodeValue","escaped","disabled","createTextNode","head","toDelete","accumulateNonPaintRules","nonPaintRules","replace","currentProperties","propertyContainerCache","updateQueue","element","$$paintPending","indexOf","processUpdateQueue","el","maybeUpdateElement","loadImages","images","args","count","onload","apply","img","Image","onerror","src","ensurePaintId","paintId","$$paintId","idCounter","getPaintRuleForElement","paintRule","$$paintRule","hasAttribute","setAttribute","text","prop","getPropertyValue","computed","getComputedStyle","$$paintObservedProperties","trim","$$paintedPropertyValues","updateElement","propertiesContainer","computedStyle","observedProperties","geom","width","clientWidth","height","clientHeight","dpr","paintedProperties","$$paintedProperties","property","value","reg","newValue","urls","hasChanged","hasPaints","token","exec","substring","painterName","currentUri","contextOptions","equivalentDpr","scaling","inputProperties","nativePixels","actualWidth","actualHeight","ctx","$$paintContext","cssContextId","canvas","clearRect","getCSSCanvasContext","display","getContext","imageSmoothingEnabled","scale","save","beginPath","paint","closePath","restore","resetTransform","uri","toDataURL","MSBlobBuilder","dataUrlToBlob","URL","revokeObjectURL","applyStyleRule","removeProperty","propertyValues","dataUrl","bin","atob","split","arr","Uint8Array","charCodeAt","createObjectURL","Blob","setProperty","a","body","supportsStyleMutations","lock","MutationObserver","records","record","added","addedNodes","nodeType","target","observe","removeChild","styleDesc","getOwnPropertyDescriptor","HTMLElement","oldStyleGetter","this","ownerElement","cssTextDesc","CSSStyleDeclaration","oldSet","set","setPropertyDesc","oldSetProperty","priority","addModule","p","code","registerPaint","worklet","realm","self","scope","parentElement","frame","win","contentWindow","doc","vars","script","transpile","String"],"mappings":"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"}